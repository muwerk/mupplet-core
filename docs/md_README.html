<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>muwerk mupplet Core Library: README</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">muwerk mupplet Core Library
   </div>
   <div id="projectbrief">muwerk applets; mupplets: functional units that support specific hardware or reusable applications</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">README </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a href="https://github.com/muwerk/mupplet-core/actions"><img src="https://github.com/muwerk/mupplet-core/workflows/PlatformIO%20CI/badge.svg" alt="PlatformIO CI" style="pointer-events: none;" class="inline"/></a> <a href="https://muwerk.github.io/mupplet-core/docs/index.html"><img src="https://img.shields.io/badge/docs-dev-blue.svg" alt="Dev Docs" style="pointer-events: none;" class="inline"/></a></p>
<p ><b>Note:</b> This project, while being released, is still WIP. Additional functionality from <a href="https://github.com/muwerk/Research-mupplets">Research-mupplets</a> is being refactored and ported into this project.</p>
<h1>mupplet-core </h1>
<p >**mu**werk a**pplet**s; mupplets: functional units that support specific hardware or reusable applications.</p>
<p ><b>mupplets</b> use muwerks MQTT-style messaging to pass information between each other on the same device. If connected to an MQTT-server via munet, all functionallity is externally available through an MQTT server such as Mosquitto.</p>
<p >The <code>mupplet-core</code> library consists of the following modules:</p>
<p ><img src="https://github.com/muwerk/mupplet-core/blob/master/extras/led.png" alt="" align="right" width="7%" height="7%" class="inline"/></p>
<ul>
<li><a href="https://muwerk.github.io/mupplet-core/docs/classustd_1_1Light.html"><code>Light</code></a> The Light GPIO mupplet allows to control a led or light's state, brightness using modes such as user-controlled, blink, soft-wave, one-time pulse and automatic pattern playback. See <a href="https://github.com/muwerk/mupplet-core/blob/master/extras/led-notes.md">Led application notes</a> for an example and more information. Complete example <a href="https://github.com/muwerk/examples/tree/master/muBlink">muBlink</a>.</li>
</ul>
<p ><img src="https://github.com/muwerk/mupplet-core/blob/master/extras/switch.png" alt="" align="right" width="10%" height="10%" class="inline"/></p>
<ul>
<li><a href="https://muwerk.github.io/mupplet-core/docs/classustd_1_1Switch.html"><code>Switch</code></a> The Switch GPIO mupplet allows to use hardware buttons and switches connected to a GPIO. Switch supports debouncing, flip-flop mode and push-button event. See <a href="https://github.com/muwerk/mupplet-core/blob/master/extras/switch-notes.md">Switch application notes</a> for an example-code and more information. Complete example <a href="https://github.com/muwerk/examples/tree/master/SwitchAndLed">SwitchAndLed</a>.</li>
</ul>
<p ><img src="https://github.com/muwerk/examples/blob/master/Resources/FrequencyCounter.jpg" alt="" align="right" width="8%" class="inline"/></p>
<ul>
<li><a href="https://muwerk.github.io/mupplet-core/docs/classustd_1_1FrequencyCounter.html"><code>FrequencyCounter</code></a> The frequency counter mupplet measures impulse frequencies on a GPIO using interrupts. An ESP32 can reliably measure up to about 80kHz. See <a href="https://github.com/muwerk/mupplet-core/blob/master/extras/frequency-counter-notes.md">FrequencyCounter application notes</a> for a Geiger counter sample.</li>
<li><a href="https://muwerk.github.io/mupplet-core/docs/classustd_1_1LightsPCA9685.html"><code>LightsPCA9685</code></a> The PCA 9685 16 Channels Light Mupplet allows to control up to 16 led or light states, brightness using modes such as user-controlled, blink, soft-wave, one-time pulse and automatic pattern playback. See <a href="https://github.com/muwerk/mupplet-core/blob/master/extras/pca9685-notes.md">PCA9685 Application Notes</a> for an example and more information.</li>
<li><a href="https://muwerk.github.io/mupplet-core/docs/classustd_1_1HomeAssistant.html"><code>Home Assistant</code></a>. Almost any mupplet can be integrated easily into home-assistant, supported are Home Assistant MQTT Switch, Binary Sensor, Sensor, and Light. The <code>home_assistant</code> mupplet handles the entire discovery- and synchronization process. For examples see <a href="https://github.com/muwerk/examples/tree/master/switchLedHomeassistant">leds and switches with home-assistant</a> or <a href="https://github.com/muwerk/examples/tree/master/binaryAndAnalogSimpleSensors">simple binary- and analog sensors</a> or <a href="https://github.com/muwerk/examples/tree/master/enviroMaster">multi-sensor environment monitoring</a>.</li>
</ul>
<p >Additional mupplet implementations can be found:</p>
<ul>
<li><a href="https://github.com/muwerk/mupplet-sensor"><code>mupplet-sensor</code></a>: implementations for various sensors, temperature, humidity, pressure, illuminance, generic binary sensors and analog sensors.</li>
<li><a href="https://github.com/muwerk/mupplet-display"><code>mupplet-display</code></a>: implementations for various displays.</li>
</ul>
<h2>Development and Design considerations </h2>
<p >Some design recommendations for mupplets:</p>
<ul>
<li>mupplets use asynchronous design. Since muwerk uses cooperative scheduling, any muwerk task can block the muwerk system. It's therefore imperative to use asychronous programming techniques with mupplets. Do not use long-running code with delays. Many third-party sensor libraries are not designed for asynchronous operation, and thus will block the muwerk system more than necessary.</li>
<li>If you interact with hardware or software that requires waiting for events, either use a state-machine or interrupt handlers, and give back control to the muwerk scheduler as soon as possible. Avoid polling for events in a delay-loop.</li>
<li>As a rule of thumb: avoid blocking operations &gt; 10ms.</li>
<li>Use muwerks pub/sub mechanism to interface between other mupplets and the outside world. Compose using messages and functional interfaces with light coupling that do not impose object hierarchies on the programs that use a mupplet.</li>
<li>If your mupplet exposes an API, make sure that the same functionality is accessible via pub/sub messages.</li>
<li>Mupplets compose with pub/sub messages. If a mupplet uses functionality of another Mupplet, they should use pub/sub messages. Example: a CO2 sensor-mupplet requires the current temperature for calibration: the CO2 mupplet would subscribe to the messages a temperature mupplet would publish. A major advantage of this type of light coupling via messages is that the temperature mupplet could run on a different hardware: an MQTT server and munet make sure that there is absolutely no difference between remote and local communication partners: the implementation of both mupplets in both cases is simply the same. Additionally this facilitates a later port to multi-core and preemtive multi-tasking systems.</li>
</ul>
<h3>Examples</h3>
<ul>
<li>A mupplet can implement a driver for a hardware sensor (e.g. temperature sensor)</li>
<li>If a hardware is for a very specific purpose, even application-style logic can be part of a mupplet. E.g. a 4-digit 7-segment clock display with a colon between 2nd and 3rd digit is basically suited to display time. In additional to implement the basic hardware the mupplet could implement the functions of a basic clock</li>
<li>The clock mupplet could (optionally) subscribe to the messages a button publishes to implement functions like "stop alarm".</li>
<li>munet's network stacks are basically mupplets themselves.</li>
</ul>
<h2>Structure </h2>
<p >An example framework for a mupplet:</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">#define __ESP__         // Platform define, see ustd library</div>
<div class="line">#include &lt;ustd_platform.h&gt;   // ustd library</div>
<div class="line">#include &lt;muwerk.h&gt;     // muwerk library</div>
<div class="line"> </div>
<div class="line">namespace ustd {</div>
<div class="line">class MyMupplet {</div>
<div class="line">  public:</div>
<div class="line">    String name;</div>
<div class="line">    uint8_t addr;  // some hardware address that cannot change</div>
<div class="line">    Scheduler *pSched;  // pointer to muwerk scheduler object, used to start</div>
<div class="line">                        // tasks and to pub/sub messages;</div>
<div class="line">    bool bActive=false; // set to true if conditions for operation are met</div>
<div class="line">                        // (e.g. hardware found and initialized.)</div>
<div class="line">    void MyMupplet(String name): name(name), addr(addr) {</div>
<div class="line">        // Minimal code in constructor, just save invariants like the mupplet&#39;s</div>
<div class="line">        // name and immutable hardware parameters.</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    void begin(Scheduler *_pSched) {</div>
<div class="line">        pSched=_pSched;  // save muwerk pointer</div>
<div class="line"> </div>
<div class="line">        // now intialize hard- and software that is used with this mupplet,</div>
<div class="line">        // e.g. initialize a sensor.</div>
<div class="line">        // If things go ok:</div>
<div class="line">        bActive=true;</div>
<div class="line"> </div>
<div class="line">        // Initialize the worker &quot;thread&quot;:</div>
<div class="line">        auto loopfunc = [=]() { this-&gt;loop(); };</div>
<div class="line">        int tID = pSched-&gt;add(loopfunc, name, 100000);</div>
<div class="line">        // Scheduler will now call loop() every 100ms (100000us).</div>
<div class="line"> </div>
<div class="line">        // Subscribe to one or more topics to expose the mupplet&#39;s</div>
<div class="line">        // functionality</div>
<div class="line">        auto fnall = [=](String topic, String msg, String originator) {</div>
<div class="line">            this-&gt;subsMsg(topic, msg, originator);</div>
<div class="line">        };</div>
<div class="line">        pSched-&gt;subscribe(tID, name + &quot;/light/#&quot;, fnall);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    // loop is called by the scheduler according to the setting in begin()</div>
<div class="line">    void loop() {</div>
<div class="line">        // Implement the main functionality here.</div>
<div class="line">        // Avoid blocking or polling as much as possible</div>
<div class="line">        if (bActive) { // Initialization in setup() was successful</div>
<div class="line">            // calculation... [state-machine]</div>
<div class="line">            // We got a result, lets publish!</div>
<div class="line">            pSched-&gt;publish(name+&quot;/state&quot;, &quot;Some data here&quot;);</div>
<div class="line">            // Other instances that have subscribed to &lt;name&gt;/state will receive</div>
<div class="line">            // &quot;Some data here&quot;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    // subsMsg is called by the scheduler, if a message that has been</div>
<div class="line">    // subscribed is available</div>
<div class="line">    void subsMsg(String topic, String msg, String originator) {</div>
<div class="line">        // A message with topic topic and content msg has been received</div>
<div class="line">        // from muwerk process with name originator.</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">}; // MyMupplet</div>
<div class="line"> </div>
<div class="line">} // ustd</div>
</div><!-- fragment --><h2>History </h2>
<ul>
<li>0.5.0 (2022-09-22)<ul>
<li>New HomeAssistant Device Autodiscovery Helper</li>
<li>New 16 channel light applet using PCA 9685 PWM controller</li>
<li>Number in string detection functions</li>
<li>Support for ASCII part HD44780 displays charset conversions (see: <a href="https://github.com/muwerk/mupplet-display">mupplet-display</a>)</li>
<li>count option for switch to count switch events.</li>
<li>Astro helper module for sunrise sunset calculations (WIP!)</li>
</ul>
</li>
<li>0.4.0 (2021-02-28) Frequency counter<ul>
<li>Frequency counter mupplet (Frequency measurement up to 80kHz on ESP32)</li>
<li>Codepage conversion utility functions (ISO8859-1 &lt;-&gt; UTF8)</li>
<li>New parser function <code>parseLong</code></li>
<li>Improvements in parser functions</li>
</ul>
</li>
<li>0.3.0 (2021-02-19) New helpful parser functions</li>
<li>0.2.0 (2021-02-13) Consistent naming, documentation fixes, configurable topic in <code>DigitalOut</code>.</li>
<li>0.1.1 (2021-02-13) Broken repository-url fixed for <code>library.json</code>.</li>
<li>0.1.0 (2021-02-13) Mupplets for basic I/O, leds and switches.</li>
</ul>
<h2>More mupplet libraries </h2>
<ul>
<li><a href="https://github.com/muwerk/mupplet-sensor">mupplet-sensor</a> microWerk Sensor mupplets</li>
<li><a href="https://github.com/muwerk/mupplet-display">mupplet-display</a> microWerk Display mupplets</li>
</ul>
<h2>References </h2>
<ul>
<li><a href="https://github.com/muwerk/ustd">ustd</a> microWerk standard library</li>
<li><a href="https://github.com/muwerk/muwerk">muwerk</a> microWerk scheduler</li>
<li><a href="https://github.com/muwerk/munet">munet</a> microWerk networking </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5
</small></address>
</body>
</html>
